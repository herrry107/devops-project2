pipeline {
  agent { label 'jenkins-Agent' }

  tools {
    jdk 'Java17'
    maven 'Maven3'
  }

  environment {
    APP_NAME = "register-app-pipeline"
    RELEASE = "1.0.0"
    DOCKER_USER = "herrypr107"
    DOCKER_PASS = 'dockerhub'
    IMAGE_NAME = "${DOCKER_USER}/${APP_NAME}"
    IMAGE_TAG = "${RELEASE}-${BUILD_NUMBER}"
  }

  triggers {
    githubPush()
  }

  stages {

    stage("Cleanup Workspace") {
      steps {
        cleanWs()
      }
    }

    stage("Checkout from SCM") {
      steps {
        git branch: 'main',
            credentialsId: 'github',
            url: 'https://github.com/herrry107/devops-project2'
      }
    }

    stage("Detect Changes") {
      steps {
        script {
          def changedFiles = sh(
            script: "git diff --name-only HEAD~1",
            returnStdout: true
          ).trim()

          echo "Changed files:\n${changedFiles}"

          if (changedFiles &&
              changedFiles.split('\n').every { it.startsWith('helm/') }) {
            echo "Only helm folder changed. Skipping pipeline."
            currentBuild.result = 'NOT_BUILT'
            error("Skipping build due to helm-only changes")
          }
        }
      }
    }

    stage("Build Application") {
      steps {
        sh "mvn clean package"
      }
    }

    stage("Test Application") {
      steps {
        sh "mvn test"
      }
    }

    stage("Build & Push Docker Image") {
      steps {
        script {
          docker.withRegistry('', DOCKER_PASS) {
            docker_image = docker.build("${IMAGE_NAME}")
            docker_image.push("${IMAGE_TAG}")
          }
        }
      }
    }

    stage("Cleanup Artifacts") {
      steps {
        sh "docker rmi ${IMAGE_NAME}:${IMAGE_TAG} || true"
      }
    }

    stage("Update Helm Image Tag & Push") {
      when {
        expression { currentBuild.result == null || currentBuild.result == 'SUCCESS' }
      }
      steps {
        script {
          def newTag = "${IMAGE_TAG}"

      sh """
        echo "Updating helm/values.yaml with image tag: ${newTag}"

        sed -i 's|tag:.*|tag: "${newTag}"|' helm/values.yaml

        git config user.name "jenkins-bot"
        git config user.email "jenkins@local"

        git add helm/values.yaml
        git commit -m "Update image tag to ${newTag} [ci skip]"
      """

      withCredentials([usernamePassword(
        credentialsId: 'github',
        usernameVariable: 'GIT_USER',
        passwordVariable: 'GIT_TOKEN'
      )]) {
        sh """
          git push https://${GIT_USER}:${GIT_TOKEN}@github.com/herrry107/devops-project2.git HEAD:main
        """
      }
    }
  }
}

  }
}
