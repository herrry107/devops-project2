pipeline {
  agent { label 'jenkins-Agent' }

  tools {
    jdk 'Java17'
    maven 'Maven3'
  }

  environment {
    APP_NAME = "register-app-pipeline"
    RELEASE = "1.0.0"
    DOCKER_USER = "herrypr107"
    DOCKER_PASS = 'dockerhub'
    IMAGE_NAME = "${DOCKER_USER}/${APP_NAME}"
    IMAGE_TAG = "${RELEASE}-${BUILD_NUMBER}"
  }

  triggers {
    githubPush()
  }

  stages {

    stage("Cleanup Workspace") {
      steps {
        cleanWs()
      }
    }

    stage("Checkout from SCM") {
      steps {
        git branch: 'main',
            credentialsId: 'github',
            url: 'https://github.com/herrry107/devops-project2'
      }
    }

    stage("Detect Changes") {
      steps {
        script {
          def changedFiles = sh(
            script: "git diff --name-only HEAD~1",
            returnStdout: true
          ).trim()

          echo "Changed files:\n${changedFiles}"

          if (changedFiles &&
              changedFiles.split('\n').every { it.startsWith('helm/') }) {
            echo "Only helm folder changed. Skipping pipeline."
            currentBuild.result = 'NOT_BUILT'
            error("Skipping build due to helm-only changes")
          }
        }
      }
    }

    stage("Build Application") {
      steps {
        sh "mvn clean package"
      }
    }

    stage("Test Application") {
      steps {
        sh "mvn test"
      }
    }

    stage("Build & Push Docker Image") {
      steps {
        script {
          docker.withRegistry('', DOCKER_PASS) {
            docker_image = docker.build("${IMAGE_NAME}")
            docker_image.push("${IMAGE_TAG}")
          }
        }
      }
    }

    stage("Trivy Scan") {
      steps {
        sh """
        docker run -v /var/run/docker.sock:/var/run/docker.sock \
        aquasec/trivy image ${IMAGE_NAME}:${IMAGE_TAG} \
        --no-progress --scanners vuln --exit-code 0 \
        --severity HIGH,CRITICAL --format table
        """
      }
    }

    stage("Cleanup Artifacts") {
      steps {
        sh "docker rmi ${IMAGE_NAME}:${IMAGE_TAG} || true"
      }
    }
  }
}
